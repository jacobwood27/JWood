<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/basic.css"> <link rel=icon  href="/assets/favicon.png"> <title>Photobooth</title> <header> <div class=blog-name ><a href="/">Jacob Wood</a></div> <nav> <ul> <li><a href="/projects/">Projects</a> <li><a href="/projects/books/">Books</a> <li><a href="/projects/inklings/">Inklings</a> <li><a href="/resume">Resume</a> <li><a href="/now">Now</a> </ul> <img src="/assets/hamburger.svg" id=menu-icon > </nav> </header> <div class=franklin-content ><p>My wife and I planned on having a small photobooth at our wedding in case people wanted to print and keep a small memento. A week before the wedding I had a few ideas pop up that I thought would be fun to incorporate into the photobooth. Unfortunately you end up kind of busy doing a bunch of other things the week of your wedding, so I didn&#39;t get to finish this photobooth in time. To round out the learning process I did complete it after the wedding - this project documents the build.</p> <h2 id=existing_solutions ><a href="#existing_solutions" class=header-anchor >Existing Solutions</a></h2> <h3 id=tabletphone_apps ><a href="#tabletphone_apps" class=header-anchor >Tablet/Phone Apps</a></h3> <p><a href="https://www.simplebooth.com/">SimpleBooth</a> or <a href="https://myphotoboothapp.com/">myphotoboothapp</a> seem to be effective apps, but lack the customization I thought would be entertaining. Requires hardware.</p> <h3 id=rental ><a href="#rental" class=header-anchor >Rental</a></h3> <p>Rental photobooths are available in our area, but they tend to be pricy and require an attendant for the night.</p> <h3 id=python_application ><a href="#python_application" class=header-anchor >Python Application</a></h3> <p><a href="https://pypi.org/project/pibooth/">Pibooth</a> looks to be a great application and would certainly get the job done. This would be the preferred solution if I wasn&#39;t looking for a learning exercise. Requires hardware.</p> <h2 id=software ><a href="#software" class=header-anchor >Software</a></h2> <p>I wanted to implement a few novel things in this photobooth:</p> <ul> <li><p>Completely touchless operation</p> <li><p>Different interaction modalities</p> <li><p>Landing screen minigame</p> <li><p>Automatic cloud upload of full-res media</p> </ul> <h3 id=architecture ><a href="#architecture" class=header-anchor >Architecture</a></h3> <p>In order to interact touchlessly with the application we&#39;ll rely on some human pose detection and image processing. The Python ecosystem offers plenty of existing libraries to do all of the heavy lifting, so we&#39;ll write the entire application in Python.</p> <p><a href="https://pysimplegui.readthedocs.io/en/latest/">PySimpleGUI</a> offers an impressive set of features and seemed to cross off everything I was looking for in a GUI. It was my first time using this package and it will likely see future use.</p> <p>The general outline I assumed for this application was a collection of &quot;layouts&quot;, each with distinct elements, for each planned user interaction. The layouts are all children of the main window environment and get shown/hidden as necessary. <img src="/projects/photobooth/layout_diagram.png" alt=""></p> <p><a href="https://opencv.org/">OpenCV</a> will be used for image capture and manipulation.</p> <p>Google&#39;s <a href="https://google.github.io/mediapipe/">Mediapipe</a> performs impressively lightweight face, hand, and pose recognition and is used extensively throughout.</p> <h3 id=landing_page ><a href="#landing_page" class=header-anchor >Landing Page</a></h3> <p>The landing page houses most of the fun stuff. This is where the user will select their chosen modality and this is where they will be able to play the minigame. The layout should looke like: <img src="/projects/photobooth/landing_diagram.png" alt=""></p> <p>This is easy enough to create in PySimpleGUI layout language:</p> <pre><code class="Python hljs">LANDING_LAYOUT = [  
        [sg.Text(<span class=hljs-string >&#x27;Welcome to Our (touch free) Photobooth!&#x27;</span>, font=<span class=hljs-string >&#x27;AmaticSC 100&#x27;</span>)],
        [sg.Image(<span class=hljs-string >&#x27;cam_placeholder.png&#x27;</span>, key=<span class=hljs-string >&#x27;landing_im&#x27;</span>)], 
        [sg.Text(<span class=hljs-string >&#x27;please select an option above with your camera hands&#x27;</span>,justification=<span class=hljs-string >&#x27;center&#x27;</span>, size=(<span class=hljs-number >100</span>,<span class=hljs-number >1</span>), font=<span class=hljs-string >&#x27;AmaticSC 60&#x27;</span>)],
        [sg.Column([[sg.Text(<span class=hljs-string >&#x27;Current Score: 0&#x27;</span>, font=<span class=hljs-string >&#x27;AmaticSC 20&#x27;</span>,justification=<span class=hljs-string >&#x27;right&#x27;</span>, pad=<span class=hljs-number >0</span>, key=<span class=hljs-string >&#x27;current_score&#x27;</span>),]], pad=<span class=hljs-number >0</span>,justification = <span class=hljs-string >&#x27;right&#x27;</span>, element_justification = <span class=hljs-string >&#x27;right&#x27;</span>)],
        [sg.Column([[sg.Text(<span class=hljs-string >&#x27;High Score: 0&#x27;</span>, font=<span class=hljs-string >&#x27;AmaticSC 20&#x27;</span>,justification=<span class=hljs-string >&#x27;right&#x27;</span>, pad=<span class=hljs-number >0</span>, key=<span class=hljs-string >&#x27;high_score&#x27;</span>),]], pad=<span class=hljs-number >0</span>,justification = <span class=hljs-string >&#x27;right&#x27;</span>, element_justification = <span class=hljs-string >&#x27;right&#x27;</span>)],
        [sg.Column([[sg.Image(<span class=hljs-string >&#x27;score_placeholder.png&#x27;</span>, key=<span class=hljs-string >&#x27;high_score_face&#x27;</span>),]], pad=<span class=hljs-number >0</span>,justification = <span class=hljs-string >&#x27;right&#x27;</span>, element_justification = <span class=hljs-string >&#x27;right&#x27;</span>)]
    ]</code></pre> <p>While the landing page is in operation we feed the image placeholder new encoded .png images when they are ready from the camera. The minimal functional loop looks something like:</p> <pre><code class="Python hljs">cap = cv2.VideoCapture(<span class=hljs-string >&#x27;/dev/video0&#x27;</span>)
gui = sg.Window(<span class=hljs-string >&#x27;Erin &amp; Jacob Photobooth&#x27;</span>, layout, element_justification=<span class=hljs-string >&#x27;c&#x27;</span>, resizable = <span class=hljs-literal >True</span>, margins=(<span class=hljs-number >0</span>,<span class=hljs-number >0</span>), return_keyboard_events=<span class=hljs-literal >True</span>, location=(<span class=hljs-number >2000</span>,<span class=hljs-number >0</span>))
<span class=hljs-keyword >while</span> <span class=hljs-literal >True</span>:
    event, values = gui.read(<span class=hljs-number >25</span>)
    ret,frame = cap.read()
    frame = cv2.flip(frame, <span class=hljs-number >1</span>)
    gui[<span class=hljs-string >&#x27;landing_im&#x27;</span>].update(data=cv2.imencode(<span class=hljs-string >&#x27;.png&#x27;</span>, frame))[<span class=hljs-number >1</span>].tobytes())</code></pre> <p>The first thing we&#39;ll add are the overlay rectangles on the image frame that show the available selections:</p> <pre><code class="Python hljs"><span class=hljs-comment ># Define rectangles</span>
S_coords = [(<span class=hljs-number >0.1</span>,<span class=hljs-number >0.08</span>), (<span class=hljs-number >0.4</span>,<span class=hljs-number >0.08</span>), (<span class=hljs-number >0.7</span>,<span class=hljs-number >0.08</span>)]
S_labels = [<span class=hljs-string >&quot;PHOTOSTRIP&quot;</span>, <span class=hljs-string >&quot;FLIPBOOK&quot;</span>, <span class=hljs-string >&quot;VIDEO&quot;</span>]
S_box = (<span class=hljs-number >0.2</span>,<span class=hljs-number >0.15</span>)

<span class=hljs-comment ># Apply to each frame</span>
<span class=hljs-keyword >for</span> c,t <span class=hljs-keyword >in</span> <span class=hljs-built_in >zip</span>(S_coords,S_labels):
    cv2.rectangle(frame, 
            (<span class=hljs-built_in >int</span>(c[<span class=hljs-number >0</span>]*cap_x), <span class=hljs-built_in >int</span>(c[<span class=hljs-number >1</span>]*cap_y)), 
            (<span class=hljs-built_in >int</span>((c[<span class=hljs-number >0</span>]+S_box[<span class=hljs-number >0</span>])*cap_x), <span class=hljs-built_in >int</span>((c[<span class=hljs-number >1</span>]+S_box[<span class=hljs-number >1</span>])*cap_y)), 
            (<span class=hljs-number >0</span>,<span class=hljs-number >0</span>,<span class=hljs-number >0</span>), 
            -<span class=hljs-number >1</span>)
    
    TEXT_FACE = cv2.FONT_HERSHEY_DUPLEX
    TEXT_SCALE = <span class=hljs-number >0.6</span>
    TEXT_THICKNESS = <span class=hljs-number >1</span>
    text_size, _ = cv2.getTextSize(t, TEXT_FACE, TEXT_SCALE, TEXT_THICKNESS)
    text_origin = (<span class=hljs-built_in >int</span>((c[<span class=hljs-number >0</span>]+S_box[<span class=hljs-number >0</span>]/<span class=hljs-number >2</span>)*cap_x) - text_size[<span class=hljs-number >0</span>] // <span class=hljs-number >2</span>, <span class=hljs-built_in >int</span>((c[<span class=hljs-number >1</span>]+S_box[<span class=hljs-number >1</span>]/<span class=hljs-number >2</span>)*cap_y) + text_size[<span class=hljs-number >1</span>] // <span class=hljs-number >2</span>)
    cv2.putText(frame, 
            t, 
            text_origin, 
            TEXT_FACE, 
            TEXT_SCALE, 
            (<span class=hljs-number >255</span>,<span class=hljs-number >255</span>,<span class=hljs-number >255</span>), 
            TEXT_THICKNESS)</code></pre> <p>Then we&#39;ll add the ability to track all the hands in the frame and give those hands the ability to select a rectangle by moving within its bounds.</p> <pre><code class="Python hljs">selection_counter = [<span class=hljs-number >0</span> <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> S_coords] 
needed_count = <span class=hljs-number >10</span> <span class=hljs-comment >#required frames for selection</span>

<span class=hljs-keyword >with</span> mp.solutions.hands.Hands(
        min_detection_confidence=<span class=hljs-number >0.6</span>,
        min_tracking_confidence=<span class=hljs-number >0.5</span>,
        max_num_hands = <span class=hljs-number >10</span>) <span class=hljs-keyword >as</span> hands:
        
    this_frame_select = [<span class=hljs-literal >False</span> <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> S_coords]

    res_hands = hands.process(image)
    <span class=hljs-keyword >if</span> res_hands.multi_hand_landmarks:
        <span class=hljs-keyword >for</span> hand_landmarks <span class=hljs-keyword >in</span> res_hands.multi_hand_landmarks:

            <span class=hljs-comment >#Find center of hands and annotate frame</span>
            cx = np.mean([a.x <span class=hljs-keyword >for</span> a <span class=hljs-keyword >in</span> hand_landmarks.landmark])
            cy = np.mean([a.y <span class=hljs-keyword >for</span> a <span class=hljs-keyword >in</span> hand_landmarks.landmark])
            cv2.circle(frame, (<span class=hljs-built_in >round</span>(cx*frame.shape[<span class=hljs-number >1</span>]), <span class=hljs-built_in >round</span>(cy*frame.shape[<span class=hljs-number >0</span>])), <span class=hljs-number >10</span>, (<span class=hljs-number >255</span>,<span class=hljs-number >0</span>,<span class=hljs-number >255</span>), -<span class=hljs-number >1</span>)

            <span class=hljs-comment >#Check each box to see if hand is within bounds</span>
            <span class=hljs-keyword >for</span> i,c <span class=hljs-keyword >in</span> <span class=hljs-built_in >enumerate</span>(S_coords):
                <span class=hljs-keyword >if</span> (cx &gt; c[<span class=hljs-number >0</span>]) <span class=hljs-keyword >and</span> (cx &lt; c[<span class=hljs-number >0</span>]+S_box[<span class=hljs-number >0</span>]) <span class=hljs-keyword >and</span> (cy &gt; c[<span class=hljs-number >1</span>]) <span class=hljs-keyword >and</span> (cy &lt; c[<span class=hljs-number >1</span>]+S_box[<span class=hljs-number >1</span>]):
                    this_frame_select[i] = <span class=hljs-literal >True</span>
                    selection_counter[i] += <span class=hljs-number >1</span>

                    <span class=hljs-comment ># Check to see if we have fully selected this option</span>
                    <span class=hljs-keyword >if</span> selection_counter[i] &gt;= needed_count:
                        <span class=hljs-keyword >return</span> i
            
            <span class=hljs-comment ># If we aren&#x27;t selecting this box this time, decrement the counter (but not below 0)</span>
            <span class=hljs-keyword >for</span> i,tf <span class=hljs-keyword >in</span> <span class=hljs-built_in >enumerate</span>(this_frame_select):
                <span class=hljs-keyword >if</span> <span class=hljs-keyword >not</span> tf <span class=hljs-keyword >and</span> S[i]&gt;<span class=hljs-number >0</span>:
                    selection_counter[i] -= <span class=hljs-number >1</span>            

            <span class=hljs-comment ># If in the process of selecting, draw a green rectangle that changes size to show nearness to selection</span>
            <span class=hljs-keyword >for</span> c,s <span class=hljs-keyword >in</span> <span class=hljs-built_in >zip</span>(S_coords,selection_counter):
                <span class=hljs-keyword >if</span> s &gt; <span class=hljs-number >0</span>:
                    cv2.rectangle(frame, 
                            (<span class=hljs-built_in >round</span>((c[<span class=hljs-number >0</span>]+<span class=hljs-number >0.5</span>*s/needed_count*S_box[<span class=hljs-number >0</span>])*cap_x), <span class=hljs-built_in >round</span>((c[<span class=hljs-number >1</span>]+<span class=hljs-number >0.5</span>*s/needed_count*S_box[<span class=hljs-number >1</span>])*cap_y)), 
                            (<span class=hljs-built_in >round</span>((c[<span class=hljs-number >0</span>]+<span class=hljs-number >0.5</span>*s/needed_count*S_box[<span class=hljs-number >0</span>]+S_box[<span class=hljs-number >0</span>]-s/needed_count*S_box[<span class=hljs-number >0</span>])*cap_x), <span class=hljs-built_in >round</span>((c[<span class=hljs-number >1</span>]+<span class=hljs-number >0.5</span>*s/needed_count*S_box[<span class=hljs-number >1</span>]+S_box[<span class=hljs-number >1</span>]-s/needed_count*S_box[<span class=hljs-number >1</span>])*cap_y)),
                            (<span class=hljs-number >0</span>,<span class=hljs-number >255</span>,<span class=hljs-number >0</span>), 
                            <span class=hljs-number >2</span>)</code></pre> <p>So far this is what we have on the landing page:</p> <p>Let&#39;s add the minigame. The </p> <div class=im-100 ><img src="/projects/photobooth/minigame_diagram.svg" alt=""></div> <h2 id=ingredients ><a href="#ingredients" class=header-anchor >Ingredients</a></h2> <ul> <li><p><a href="https://pysimplegui.readthedocs.io/en/latest/">PySimpleGUI</a> - a Python GUI For Humans</p> <li><p><a href="https://opencv.org/">OpenCV</a></p> <li><p><a href="https://google.github.io/mediapipe/">Mediapipe</a></p> <li><p><a href="https://excalidraw.com/">Excalidraw</a> - diagram creation</p> </ul> <div class=page-foot > <div class=copyright > <a href="mailto:contact@jacobw.xyz" class="fa fa-envelope"></a> <a href="https://github.com/jacobwood27" class="fa fa-github"></a> <br> <br> Last modified: November 10, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div>